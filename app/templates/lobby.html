{% extends "base.html" %}

{% block title %}Recherche de partie - Battle of Roles{% endblock %}

{% block content %}
<div class="lobby-container">
    <div class="lobby-card">
        <h2>üîç Recherche d'adversaire...</h2>
        
        <div class="loading-spinner">
            <div class="spinner"></div>
        </div>
        
        <p class="lobby-message">En attente d'un joueur...</p>
        
        <div class="lobby-info">
            <p>Vous serez automatiquement redirig√© quand un adversaire sera trouv√©</p>
            <p id="debug-info" style="font-size: 12px; color: #64748b; margin-top: 10px;"></p>
        </div>
        
        <a href="{{ url_for('main.index') }}" class="btn btn-secondary" style="margin-top: 20px;">Annuler</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    //  R√©cup√©ration correcte du game.id depuis le template
    var gameId = parseInt('{{ game.id }}', 10);
    var checkCount = 0;
    
    console.log('üéÆ Game ID:', gameId);
    
    function updateDebugInfo(message) {
        var debugEl = document.getElementById('debug-info');
        if (debugEl) {
            debugEl.textContent = message;
        }
    }
    
    function checkGameReady() {
        checkCount++;
        
        if (!gameId || gameId === 0 || isNaN(gameId)) {
            console.error('‚ùå Game ID invalide:', gameId);
            updateDebugInfo('Erreur: Game ID invalide. Rechargement...');
            setTimeout(function() {
                window.location.href = '/lobby';
            }, 2000);
            return;
        }
        
        console.log('üîÑ V√©rification #' + checkCount + ' pour Game #' + gameId);
        updateDebugInfo('V√©rification #' + checkCount + '...');
        
        fetch('/api/check-game-ready/' + gameId)
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.json();
            })
            .then(function(data) {
                console.log('üì° R√©ponse:', data);
                
                // Si la partie a √©t√© supprim√©e, revenir √† l'accueil
                if (data.deleted) {
                    console.log('‚ö†Ô∏è Partie supprim√©e, retour √† l\'accueil...');
                    window.location.href = '/';
                    return;
                }
                
                if (data.ready) {
                    console.log('‚úÖ Adversaire trouv√© ! Redirection vers Game #' + data.game_id);
                    updateDebugInfo('Adversaire trouv√© ! D√©marrage...');
                    window.location.href = '/game/' + data.game_id;
                } else {
                    updateDebugInfo('En attente... (v√©rification #' + checkCount + ')');
                    setTimeout(checkGameReady, 2000);
                }
            })
            .catch(function(error) {
                console.error('‚ùå Erreur:', error);
                updateDebugInfo('Erreur: ' + error.message + '. Nouvelle tentative...');
                setTimeout(checkGameReady, 2000);
            });
    }
    
    // D√©marre la v√©rification
    checkGameReady();
</script>
{% endblock %}